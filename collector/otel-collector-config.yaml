# OpenTelemetry Collector configuration for ApolloTech Claude Code metrics
#
# Receives OTLP over HTTP/protobuf (port 4318, TLS-terminated upstream).
# Authenticates via per-developer basic auth (htpasswd).
# Exports metrics to Prometheus and logs to a file.

extensions:
  # Per-developer basic auth via htpasswd file
  basicauth/server:
    htpasswd:
      file: /etc/otel/htpasswd

  health_check:
    endpoint: "0.0.0.0:13133"

receivers:
  otlp:
    protocols:
      http:
        endpoint: "0.0.0.0:4318"
        include_metadata: true
        auth:
          authenticator: basicauth/server

processors:
  # Normalize/enrich resource attributes
  resource:
    attributes:
      # Ensure team attribute is always present
      - key: team
        value: engineering
        action: insert
      # Normalize service name
      - key: service.name
        value: claude-code
        action: upsert

  # Extract X-Apollo-Repository header into a data-point attribute (IDE plugin path).
  # action: insert means it's a no-op if repository is already set (CLI wrapper path).
  # Uses attributes processor (not resource) because from_context is only supported there.
  # resource_to_telemetry_conversion on the Prometheus exporter promotes these to labels.
  attributes/repo-from-header:
    actions:
      - key: repository
        from_context: metadata.x-apollo-repository
        action: insert

  # Batch for efficiency
  batch:
    timeout: 10s
    send_batch_size: 1024

  # Drop any accidentally included prompt content (defence-in-depth)
  # Attributes that could contain prompt text are removed.
  attributes:
    actions:
      - key: prompt
        action: delete
      - key: completion
        action: delete
      - key: message.content
        action: delete

  memory_limiter:
    check_interval: 5s
    limit_mib: 256
    spike_limit_mib: 64

exporters:
  # Prometheus exporter — scrape endpoint for Grafana dashboards
  prometheus:
    endpoint: "0.0.0.0:8889"
    resource_to_telemetry_conversion:
      enabled: true  # expose developer/repository labels on every metric

  # File exporter for logs (tool events, API calls, token usage per-request)
  file:
    path: /var/log/otel/claude-events.jsonl
    rotation:
      max_megabytes: 100
      max_days: 30
      max_backups: 5

  # Loki exporter — queryable log storage for Grafana Explore
  otlphttp/loki:
    endpoint: http://loki:3100/otlp
    tls:
      insecure: true

  # Optional: forward everything to a remote OTLP backend
  # Uncomment and configure if you add a central store later.
  # otlp/remote:
  #   endpoint: "https://your-backend.example.com"
  #   headers:
  #     Authorization: "Bearer ${env:REMOTE_BACKEND_TOKEN}"

service:
  extensions:
    - basicauth/server
    - health_check

  pipelines:
    metrics:
      receivers: [otlp]
      processors: [memory_limiter, resource, attributes/repo-from-header, attributes, batch]
      exporters: [prometheus]

    logs:
      receivers: [otlp]
      processors: [memory_limiter, resource, attributes/repo-from-header, attributes, batch]
      exporters: [file, otlphttp/loki]

  telemetry:
    logs:
      level: "warn"
