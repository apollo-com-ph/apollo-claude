{
  "uid": "claude-code-per-user",
  "title": "Claude Code - Per User",
  "tags": ["claude-code", "otel", "per-user"],
  "timezone": "browser",
  "refresh": "30s",
  "time": { "from": "now-24h", "to": "now" },
  "templating": {
    "list": [
      {
        "name": "user",
        "type": "query",
        "datasource": { "type": "loki", "uid": "loki" },
        "query": { "label": "user_email", "stream": "{service_name=\"claude-code\"}", "type": 1 },
        "includeAll": false,
        "current": {},
        "refresh": 2,
        "multi": false
      },
      {
        "name": "model",
        "type": "query",
        "datasource": { "type": "loki", "uid": "loki" },
        "query": { "label": "model", "stream": "{service_name=\"claude-code\"}", "type": 1 },
        "includeAll": true,
        "allValue": ".*",
        "current": { "text": "All", "value": "$__all" },
        "refresh": 2,
        "multi": true
      }
    ]
  },
  "panels": [
    {
      "id": 100,
      "title": "User Summary",
      "type": "row",
      "gridPos": { "h": 1, "w": 24, "x": 0, "y": 0 },
      "panels": [],
      "collapsed": false
    },
    {
      "id": 1,
      "title": "User Cost (USD)",
      "type": "stat",
      "gridPos": { "h": 5, "w": 4, "x": 0, "y": 1 },
      "datasource": { "type": "loki", "uid": "loki" },
      "targets": [{
        "expr": "sum(sum_over_time({service_name=\"claude-code\"} | event_name=\"api_request\" | user_email=~\"$user\" | model=~\"$model\" | unwrap cost_usd [$__range]))",
        "legendFormat": "Cost"
      }],
      "fieldConfig": {
        "defaults": {
          "unit": "currencyUSD",
          "decimals": 2,
          "thresholds": {
            "steps": [
              { "color": "green", "value": null },
              { "color": "yellow", "value": 10 },
              { "color": "red", "value": 50 }
            ]
          }
        }
      }
    },
    {
      "id": 2,
      "title": "User Sessions",
      "type": "stat",
      "gridPos": { "h": 5, "w": 4, "x": 4, "y": 1 },
      "datasource": { "type": "loki", "uid": "loki" },
      "targets": [{
        "expr": "count(sum by (session_id) (count_over_time({service_name=\"claude-code\", event_name=\"user_prompt\"} | user_email=~\"$user\" [$__range])))"
      }],
      "fieldConfig": { "defaults": { "noValue": "0", "thresholds": { "steps": [{ "color": "blue", "value": null }] } } }
    },
    {
      "id": 3,
      "title": "User Prompts",
      "type": "stat",
      "gridPos": { "h": 5, "w": 4, "x": 8, "y": 1 },
      "datasource": { "type": "loki", "uid": "loki" },
      "targets": [{
        "expr": "sum(count_over_time({service_name=\"claude-code\", event_name=\"user_prompt\"} | user_email=~\"$user\" [$__range]))"
      }],
      "fieldConfig": { "defaults": { "noValue": "0", "thresholds": { "steps": [{ "color": "purple", "value": null }] } } }
    },
    {
      "id": 4,
      "title": "User API Requests",
      "type": "stat",
      "gridPos": { "h": 5, "w": 4, "x": 12, "y": 1 },
      "datasource": { "type": "loki", "uid": "loki" },
      "targets": [{
        "expr": "sum(count_over_time({service_name=\"claude-code\"} | event_name=\"api_request\" | user_email=~\"$user\" | model=~\"$model\" [$__range]))"
      }],
      "fieldConfig": { "defaults": { "noValue": "0", "thresholds": { "steps": [{ "color": "super-light-blue", "value": null }] } } }
    },
    {
      "id": 5,
      "title": "User Total Tokens",
      "type": "stat",
      "gridPos": { "h": 5, "w": 4, "x": 16, "y": 1 },
      "datasource": { "type": "loki", "uid": "loki" },
      "targets": [{
        "expr": "sum(sum_over_time({service_name=\"claude-code\"} | event_name=\"api_request\" | user_email=~\"$user\" | model=~\"$model\" | unwrap input_tokens [$__range])) + sum(sum_over_time({service_name=\"claude-code\"} | event_name=\"api_request\" | user_email=~\"$user\" | model=~\"$model\" | unwrap output_tokens [$__range]))"
      }],
      "fieldConfig": { "defaults": { "noValue": "0", "thresholds": { "steps": [{ "color": "orange", "value": null }] } } }
    },
    {
      "id": 6,
      "title": "User API Errors",
      "type": "stat",
      "gridPos": { "h": 5, "w": 4, "x": 20, "y": 1 },
      "datasource": { "type": "loki", "uid": "loki" },
      "targets": [{
        "expr": "sum(count_over_time({service_name=\"claude-code\"} | event_name=\"api_error\" | user_email=~\"$user\" [$__range]))"
      }],
      "fieldConfig": { "defaults": { "noValue": "0", "thresholds": { "steps": [{ "color": "green", "value": null }, { "color": "red", "value": 1 }] } } }
    },

    {
      "id": 101,
      "title": "User Cost & Tokens",
      "type": "row",
      "gridPos": { "h": 1, "w": 24, "x": 0, "y": 6 },
      "panels": [],
      "collapsed": false
    },
    {
      "id": 10,
      "title": "User Cost Over Time",
      "type": "timeseries",
      "gridPos": { "h": 8, "w": 12, "x": 0, "y": 7 },
      "datasource": { "type": "loki", "uid": "loki" },
      "targets": [{
        "expr": "sum by (model) (sum_over_time({service_name=\"claude-code\"} | event_name=\"api_request\" | user_email=~\"$user\" | model=~\"$model\" | unwrap cost_usd [$__interval]))",
        "legendFormat": "{{model}}"
      }],
      "fieldConfig": {
        "defaults": {
          "unit": "currencyUSD",
          "custom": { "fillOpacity": 20, "stacking": { "mode": "normal" } }
        }
      }
    },
    {
      "id": 11,
      "title": "User Token Usage Over Time",
      "type": "timeseries",
      "gridPos": { "h": 8, "w": 12, "x": 12, "y": 7 },
      "datasource": { "type": "loki", "uid": "loki" },
      "targets": [
        {
          "expr": "sum(sum_over_time({service_name=\"claude-code\"} | event_name=\"api_request\" | user_email=~\"$user\" | model=~\"$model\" | unwrap input_tokens [$__interval]))",
          "legendFormat": "Input"
        },
        {
          "expr": "sum(sum_over_time({service_name=\"claude-code\"} | event_name=\"api_request\" | user_email=~\"$user\" | model=~\"$model\" | unwrap output_tokens [$__interval]))",
          "legendFormat": "Output"
        },
        {
          "expr": "sum(sum_over_time({service_name=\"claude-code\"} | event_name=\"api_request\" | user_email=~\"$user\" | model=~\"$model\" | unwrap cache_read_tokens [$__interval]))",
          "legendFormat": "Cache Read"
        },
        {
          "expr": "sum(sum_over_time({service_name=\"claude-code\"} | event_name=\"api_request\" | user_email=~\"$user\" | model=~\"$model\" | unwrap cache_creation_tokens [$__interval]))",
          "legendFormat": "Cache Creation"
        }
      ],
      "fieldConfig": { "defaults": { "custom": { "fillOpacity": 10 } } }
    },
    {
      "id": 12,
      "title": "User Cost by Model",
      "type": "piechart",
      "gridPos": { "h": 8, "w": 8, "x": 0, "y": 15 },
      "datasource": { "type": "loki", "uid": "loki" },
      "targets": [{
        "expr": "sum by (model) (sum_over_time({service_name=\"claude-code\"} | event_name=\"api_request\" | user_email=~\"$user\" | model=~\"$model\" | unwrap cost_usd [$__range]))",
        "legendFormat": "{{model}}"
      }]
    },
    {
      "id": 13,
      "title": "User Token Breakdown",
      "type": "piechart",
      "gridPos": { "h": 8, "w": 8, "x": 8, "y": 15 },
      "datasource": { "type": "loki", "uid": "loki" },
      "targets": [
        {
          "expr": "sum(sum_over_time({service_name=\"claude-code\"} | event_name=\"api_request\" | user_email=~\"$user\" | model=~\"$model\" | unwrap input_tokens [$__range]))",
          "legendFormat": "Input"
        },
        {
          "expr": "sum(sum_over_time({service_name=\"claude-code\"} | event_name=\"api_request\" | user_email=~\"$user\" | model=~\"$model\" | unwrap output_tokens [$__range]))",
          "legendFormat": "Output"
        },
        {
          "expr": "sum(sum_over_time({service_name=\"claude-code\"} | event_name=\"api_request\" | user_email=~\"$user\" | model=~\"$model\" | unwrap cache_read_tokens [$__range]))",
          "legendFormat": "Cache Read"
        },
        {
          "expr": "sum(sum_over_time({service_name=\"claude-code\"} | event_name=\"api_request\" | user_email=~\"$user\" | model=~\"$model\" | unwrap cache_creation_tokens [$__range]))",
          "legendFormat": "Cache Creation"
        }
      ]
    },
    {
      "id": 14,
      "title": "User API Latency (ms)",
      "type": "timeseries",
      "gridPos": { "h": 8, "w": 8, "x": 16, "y": 15 },
      "datasource": { "type": "loki", "uid": "loki" },
      "targets": [{
        "expr": "avg by (model) (avg_over_time({service_name=\"claude-code\"} | event_name=\"api_request\" | user_email=~\"$user\" | model=~\"$model\" | unwrap duration_ms [$__interval]))",
        "legendFormat": "{{model}}"
      }],
      "fieldConfig": { "defaults": { "unit": "ms", "custom": { "fillOpacity": 10 } } }
    },

    {
      "id": 102,
      "title": "User Tool Activity",
      "type": "row",
      "gridPos": { "h": 1, "w": 24, "x": 0, "y": 23 },
      "panels": [],
      "collapsed": false
    },
    {
      "id": 20,
      "title": "User Tool Usage Over Time",
      "type": "timeseries",
      "gridPos": { "h": 8, "w": 12, "x": 0, "y": 24 },
      "datasource": { "type": "loki", "uid": "loki" },
      "targets": [{
        "expr": "sum by (tool_name) (count_over_time({service_name=\"claude-code\"} | event_name=\"tool_result\" | user_email=~\"$user\" [$__interval]))",
        "legendFormat": "{{tool_name}}"
      }],
      "fieldConfig": { "defaults": { "custom": { "fillOpacity": 20, "stacking": { "mode": "normal" } } } }
    },
    {
      "id": 21,
      "title": "User Tool Success vs Failure",
      "type": "timeseries",
      "gridPos": { "h": 8, "w": 12, "x": 12, "y": 24 },
      "datasource": { "type": "loki", "uid": "loki" },
      "targets": [
        {
          "expr": "sum(count_over_time({service_name=\"claude-code\"} | event_name=\"tool_result\" | user_email=~\"$user\" | success=\"true\" [$__interval]))",
          "legendFormat": "Success"
        },
        {
          "expr": "sum(count_over_time({service_name=\"claude-code\"} | event_name=\"tool_result\" | user_email=~\"$user\" | success=\"false\" [$__interval]))",
          "legendFormat": "Failure"
        }
      ],
      "fieldConfig": {
        "defaults": { "custom": { "fillOpacity": 20, "stacking": { "mode": "normal" } } },
        "overrides": [
          { "matcher": { "id": "byName", "options": "Success" }, "properties": [{ "id": "color", "value": { "fixedColor": "green", "mode": "fixed" } }] },
          { "matcher": { "id": "byName", "options": "Failure" }, "properties": [{ "id": "color", "value": { "fixedColor": "red", "mode": "fixed" } }] }
        ]
      }
    },
    {
      "id": 22,
      "title": "User Tool Distribution",
      "type": "piechart",
      "gridPos": { "h": 8, "w": 8, "x": 0, "y": 32 },
      "datasource": { "type": "loki", "uid": "loki" },
      "targets": [{
        "expr": "sum by (tool_name) (count_over_time({service_name=\"claude-code\"} | event_name=\"tool_result\" | user_email=~\"$user\" [$__range]))",
        "legendFormat": "{{tool_name}}"
      }]
    },
    {
      "id": 23,
      "title": "User Tool Execution Duration (ms)",
      "type": "timeseries",
      "gridPos": { "h": 8, "w": 8, "x": 8, "y": 32 },
      "datasource": { "type": "loki", "uid": "loki" },
      "targets": [{
        "expr": "avg by (tool_name) (avg_over_time({service_name=\"claude-code\"} | event_name=\"tool_result\" | user_email=~\"$user\" | unwrap duration_ms [$__interval]))",
        "legendFormat": "{{tool_name}}"
      }],
      "fieldConfig": { "defaults": { "unit": "ms", "custom": { "fillOpacity": 10 } } }
    },
    {
      "id": 24,
      "title": "User Tool Decisions",
      "type": "timeseries",
      "gridPos": { "h": 8, "w": 8, "x": 16, "y": 32 },
      "datasource": { "type": "loki", "uid": "loki" },
      "targets": [
        {
          "expr": "sum(count_over_time({service_name=\"claude-code\"} | event_name=\"tool_decision\" | user_email=~\"$user\" | decision=\"accept\" [$__interval]))",
          "legendFormat": "Accepted"
        },
        {
          "expr": "sum(count_over_time({service_name=\"claude-code\"} | event_name=\"tool_decision\" | user_email=~\"$user\" | decision=\"reject\" [$__interval]))",
          "legendFormat": "Rejected"
        }
      ],
      "fieldConfig": {
        "defaults": { "custom": { "fillOpacity": 20, "stacking": { "mode": "normal" } } },
        "overrides": [
          { "matcher": { "id": "byName", "options": "Accepted" }, "properties": [{ "id": "color", "value": { "fixedColor": "green", "mode": "fixed" } }] },
          { "matcher": { "id": "byName", "options": "Rejected" }, "properties": [{ "id": "color", "value": { "fixedColor": "red", "mode": "fixed" } }] }
        ]
      }
    },

    {
      "id": 103,
      "title": "User Prompts & Errors",
      "type": "row",
      "gridPos": { "h": 1, "w": 24, "x": 0, "y": 40 },
      "panels": [],
      "collapsed": false
    },
    {
      "id": 30,
      "title": "User Prompts Over Time",
      "type": "timeseries",
      "gridPos": { "h": 8, "w": 12, "x": 0, "y": 41 },
      "datasource": { "type": "loki", "uid": "loki" },
      "targets": [{
        "expr": "sum(count_over_time({service_name=\"claude-code\"} | event_name=\"user_prompt\" | user_email=~\"$user\" [$__interval]))",
        "legendFormat": "Prompts"
      }],
      "fieldConfig": { "defaults": { "custom": { "fillOpacity": 20 } } }
    },
    {
      "id": 31,
      "title": "User Prompt Length Over Time",
      "type": "timeseries",
      "gridPos": { "h": 8, "w": 12, "x": 12, "y": 41 },
      "datasource": { "type": "loki", "uid": "loki" },
      "targets": [
        {
          "expr": "avg(avg_over_time({service_name=\"claude-code\"} | event_name=\"user_prompt\" | user_email=~\"$user\" | unwrap prompt_length [$__interval]))",
          "legendFormat": "Avg Length"
        },
        {
          "expr": "max(max_over_time({service_name=\"claude-code\"} | event_name=\"user_prompt\" | user_email=~\"$user\" | unwrap prompt_length [$__interval]))",
          "legendFormat": "Max Length"
        }
      ],
      "fieldConfig": { "defaults": { "unit": "short", "custom": { "fillOpacity": 10 } } }
    },
    {
      "id": 32,
      "title": "User API Errors Over Time",
      "type": "timeseries",
      "gridPos": { "h": 8, "w": 12, "x": 0, "y": 49 },
      "datasource": { "type": "loki", "uid": "loki" },
      "targets": [{
        "expr": "sum by (status_code) (count_over_time({service_name=\"claude-code\"} | event_name=\"api_error\" | user_email=~\"$user\" [$__interval]))",
        "legendFormat": "HTTP {{status_code}}"
      }],
      "fieldConfig": {
        "defaults": {
          "custom": { "fillOpacity": 20, "drawStyle": "bars" },
          "color": { "mode": "palette-classic" }
        }
      }
    },
    {
      "id": 33,
      "title": "User Events Log",
      "type": "logs",
      "gridPos": { "h": 8, "w": 12, "x": 12, "y": 49 },
      "datasource": { "type": "loki", "uid": "loki" },
      "targets": [{
        "expr": "{service_name=\"claude-code\"} | user_email=~\"$user\""
      }],
      "options": { "showTime": true, "sortOrder": "Descending", "enableLogDetails": true }
    }
  ],
  "schemaVersion": 39
}
